# App Discovery & Risk Engine â€” Technical PRD

> **Status:** Draft / Approved  
> **Version:** 2.2 (Reference Consolidated Sync Strategy)

## 1. Executive Summary

This system connects to an organization's Identity Provider (Google Workspace) to **discover**, **monitor**, and **assess** every third-party application their employees are using.

We do this by:
1.  **Scanning** the Google Directory for all users and **Groups** (Engineering, Finance, etc.).
2.  **Crawling** OAuth tokens to see what apps users have granted access to.
3.  **Ingesting** Audit Logs (Activities) to see actual usage and timeline.
4.  **Filtering** noise (system apps) to focus on "Shadow IT" risks.

---

## 2. Core Concepts & Terminology

| Concept | DB Table Name | Description |
| :--- | :--- | :--- |
| **Organization** | `organization` | The customer (e.g., "Acme Corp"). |
| **Connection** | `identity_provider_connection` | A link to a specific Google Workspace environment (e.g., `acme.com`). |
| **User** | `identity_user` | An employee found in that Workspace. |
| **Group** | `identity_user_group` | A department or team (e.g., "finance@acme.com"). |
| **App** | `oauth_app` | A unique third-party software (e.g., "Slack", "Trello") identified by its `client_id`. |
| **Grant** | `app_grant` | **(Crucial)** The link where *User A* has authorized *App B*. |
| **Event** | `oauth_event` | A timestamped record of an action (Authorize, Revoke, API Call). |

---

## 3. The "Crawler Layer" (Workflows)

This is the engine of the application. It runs in the background.

### 3.1 Workflow: Onboarding a New Connection

**Goal:** User provides admin credentials -> We validate -> We start the first crawl.

1.  **User Action:** User clicks "Connect Google Workspace" (requests read-only scopes).
2.  **Callback:** Create `identity_provider_connection` (`status='pending'`).
3.  **Verify:** Call `users.list(maxResults=1)`. If success -> `status='active'`.
4.  **Trigger Sync:** Spawn background jobs for Users, Groups, Tokens, and Events.

### 3.2 Workflow: Recurring Sync (The "Crawler")

**Frequency:** Configurable.
**Job Structure:** We run atomic jobs per type to ensure resilience.
> **Note:** See `docs/consolidated_sync_strategy.md` for full implementation details (Hybrid Snapshot/Stream approach).

#### Step 1: User Discovery
*   **Source:** Google Directory API (`users.list`).
*   **Action:** Upsert `identity_user`. Handle suspended users.
*   **Why:** Foundation for everything else.

#### Step 2: Group Discovery
*   **Source:** Google Directory API (`groups.list` & `members.list`).
*   **Action:** 
    *   Upsert `identity_user_group` (Name, Email, Description).
    *   Upsert `group_membership` (Link User <-> Group).
*   **Why:** Enables consolidated risk views (e.g., "Show me specific risks in the *Finance* team").

#### Step 3: App Scanning (Tokens) & Noise Filter
*   **Source:** Google User Usage Report API (`tokens.list` per user).
*   **Action:**
    *   Fetch tokens for every active user.
    *   **Noise Filter:** If `app_name` matches `^(Android|Chrome|iOS|macOS)` or is on our System ID allowlist -> Set `is_system_app = TRUE`.
    *   **Persistence:** logic:
        *   Upsert `oauth_app` (store `raw_data`!).
        *   Upsert `app_grant` (store `raw_data`!).

#### Step 4: Event Backfill
*   **Source:** Google Reports API (`activities.list`).
*   **Action:** Fetch "Authorize" and "Revoke" events.
*   **Persistence:** Insert into `oauth_event` with `raw_data`.

---

## 4. Technical Architecture: Database Schema

### 4.1 Discovery Tables (Migrated in 006)
*Documented here for completeness.*

**`identity_user_group`** (Groups)
*   `organization_id`, `connection_id`
*   `email`, `name`, `description`
*   `raw_data`: JSONB (Store full API response)

**`group_membership`** (Links)
*   `identity_user_id`, `identity_user_group_id`
*   `role` (MEMBER, OWNER)

### 4.2 Application Inventory

**`oauth_app`**
*Represents a unique application (client_id).*

```sql
CREATE TABLE oauth_app (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organization_id BIGINT REFERENCES organization(id),
    connection_id BIGINT REFERENCES identity_provider_connection(id),

    client_id TEXT NOT NULL,
    name TEXT NOT NULL,
    
    risk_score INTEGER DEFAULT 0,
    is_system_app BOOLEAN DEFAULT FALSE, -- Noise Filter
    is_trusted BOOLEAN DEFAULT FALSE,
    
    scopes_summary TEXT[],
    image_url TEXT,
    
    raw_data JSONB DEFAULT '{}', -- REQUIRED: Store full API object
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT uq_oauth_app_client UNIQUE (connection_id, client_id)
);
```

### 4.3 App Grants (User <-> App)

**`app_grant`**
*Previously `user_app_connection`.*

```sql
CREATE TABLE app_grant (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organization_id BIGINT REFERENCES organization(id),
    connection_id BIGINT REFERENCES identity_provider_connection(id),
    
    user_id BIGINT REFERENCES identity_user(id),
    app_id BIGINT REFERENCES oauth_app(id),
    
    status VARCHAR(50) DEFAULT 'active',
    scopes TEXT[] NOT NULL,
    
    -- Timestamps
    granted_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ,
    last_accessed_at TIMESTAMPTZ,
    
    raw_data JSONB DEFAULT '{}', -- REQUIRED: Store full token object
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    CONSTRAINT uq_app_grant_user_app UNIQUE (user_id, app_id)
);
```

### 4.4 OAuth Events (Log)

**`oauth_event`**

```sql
CREATE TABLE oauth_event (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organization_id BIGINT REFERENCES organization(id),
    connection_id BIGINT REFERENCES identity_provider_connection(id),
    
    user_id BIGINT REFERENCES identity_user(id),
    app_id BIGINT REFERENCES oauth_app(id),
    
    event_type VARCHAR(50) NOT NULL,
    event_time TIMESTAMPTZ NOT NULL,
    
    raw_data JSONB DEFAULT '{}', -- REQUIRED: Store full event object
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 4.5 Crawl History (Job Tracking)

**`crawl_history`**
*Tracks individual run segments.*

```sql
CREATE TYPE crawl_type AS ENUM ('users', 'groups', 'tokens', 'events', 'full');
CREATE TYPE crawl_status AS ENUM ('running', 'success', 'error', 'partial');

CREATE TABLE crawl_history (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    organization_id BIGINT REFERENCES organization(id),
    connection_id BIGINT REFERENCES identity_provider_connection(id),

    crawl_type crawl_type NOT NULL,      -- e.g. 'users'
    status crawl_status NOT NULL,
    
    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    finished_at TIMESTAMPTZ,
    
    error_message TEXT,
    stats_json JSONB,                    -- e.g. {"scanned": 100, "new": 5}
    raw_debug_json JSONB                 -- Optional debug info
);
```

---

## 5. UI Data Consumption

### 5.1 Dashboard: "Risky Apps"
*   **Query:** `SELECT * FROM oauth_app WHERE is_system_app = FALSE`.
*   **Context:** Show apps with high risk scores first.

### 5.2 View: "By Department" (New)
*   **Goal:** "What apps are Engineering using?"
*   **Logic:**
    1.  Join `app_grant` -> `identity_user` -> `group_membership` -> `identity_user_group`.
    2.  Filter where `identity_user_group.name = 'Engineering'`.
    3.  Group by `app_id`.

### 5.3 View: "App Details"
*   **Details:** Show scopes, user count, and timeline.
*   **Debug:** Admin can view `raw_data` JSON for deep inspection if something looks wrong.
